<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Control de Gastos (Resumen Anual)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .horizontal-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        #grid-wrapper[data-weeks="4"] .week-5 {
            display: none;
        }
        input[type="number"], input[type="text"], textarea {
            font-size: 16px !important; /* Anti-zoom iOS */
        }
        /* Estilos para el log de movimientos */
        #caja-log li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        #caja-log li:last-child {
            border-bottom: none;
        }
        #caja-log .log-concepto {
            font-size: 0.9rem;
        }
        #caja-log .log-fecha {
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
        }
        #caja-log .log-monto.deposito {
            color: #16a34a; /* green-600 */
        }
        #caja-log .log-monto.retiro {
            color: #dc2626; /* red-600 */
        }

        /* Estilos para Resumen Anual */
        #summary-list .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        #summary-list .summary-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen antialiased">

    <!-- Contenedor principal de la App -->
    <div id="app-container" class="container mx-auto max-w-6xl p-4 md:p-8">

        <!-- VISTA: Menú Principal -->
        <div id="main-menu" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl text-center w-full max-w-md">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
                    Mi Control de Gastos
                </h1>
                <p class="text-lg text-gray-600 mb-10">
                    Tu app de finanzas simple y al grano.
                </p>
                <button id="goToRegisterBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105 shadow-lg w-full">
                    Registrar Gastos
                </button>
                <!-- ****** NUEVO: BOTÓN RESUMEN ANUAL ****** -->
                <button id="goToSummaryBtn" class="mt-4 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all transform hover:scale-105 shadow-lg w-full">
                    Resumen Anual
                </button>
            </div>
        </div>

        <!-- VISTA: Registro de Gastos (Oculta) -->
        <div id="register-view" class="hidden">
            <!-- Header: Botón de volver y Título -->
            <div class="flex items-center mb-4">
                <button id="backToMenuBtn" class="text-gray-500 hover:text-gray-900 text-3xl font-bold transition-all self-start p-2 -ml-2">
                    &larr;
                </button>
                <h2 class="text-3xl font-bold text-gray-900 text-center flex-1 ml-4">
                    Registro de Pagos
                </h2>
            </div>

            <!-- ****** CAMBIO: SELECTOR DE MES (LOS COLORES SE APLICAN CON JS) ****** -->
            <select id="month-select" class="w-full text-white p-3 text-center text-3xl font-extrabold tracking-widest uppercase appearance-none rounded-t-2xl shadow-lg focus:outline-none cursor-pointer transition-colors duration-300">
                <!-- Opciones de mes -->
            </select>

            <!-- Contenedor del Grid (ahora con rounded-b-2xl) -->
            <div class="bg-white rounded-b-2xl shadow-xl overflow-hidden">
                
                <div class="horizontal-scroll">
                    <!-- Wrapper del Grid -->
                    <div id="grid-wrapper" class="min-w-[800px] md:min-w-full" data-weeks="5">
                        <!-- Encabezado del Grid -->
                        <div id="grid-header" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] bg-gray-200 p-4 font-bold sticky top-0 z-10 gap-2 text-base">
                            <!-- Se genera con JS -->
                        </div>
                        <!-- Cuerpo del Grid -->
                        <div id="grid-body" class="p-4 space-y-2">
                            <div id="sueldo-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white rounded-lg" data-row-type="sueldo">
                                <!-- Contenido generado por JS -->
                            </div>
                            <!-- Filas de gastos se insertan aquí -->
                        </div>
                        <!-- Pie de página del Grid (Totales) -->
                        <div id="grid-footer" class="bg-gray-50 p-4 space-y-2 sticky bottom-0 z-10 border-t border-gray-200">
                            <div id="totals-gastos-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center font-bold text-gray-700">
                                <!-- Contenido generado por JS -->
                            </div>
                            <div id="totals-restante-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center font-bold">
                                <!-- Contenido generado por JS -->
                            </div>
                        </div>
                    </div> <!-- Fin grid-wrapper -->
                </div> <!-- Fin horizontal-scroll -->

                <!-- Botones de Acción -->
                <div class="bg-white p-4 border-t border-gray-200 flex justify-between items-center">
                    <button id="add-row-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all text-base">
                        + Agregar Gasto
                    </button>
                    <span id="save-status" class="text-sm text-gray-500 font-medium">Listo ✔</span>
                </div>
            </div>

            <!-- Panel de Caja de Ahorro -->
            <div id="caja-ahorro-view" class="mt-8 bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Caja de Ahorro</h3>
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="text-center md:text-left">
                            <p class="text-sm font-medium text-gray-500 uppercase">Saldo Actual</p>
                            <p id="caja-saldo" class="text-4xl font-bold text-green-600">$0.00</p>
                        </div>
                        <div class="flex gap-3 justify-center">
                            <button id="caja-retiro-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-all">
                                Retirar
                            </button>
                            <button id="caja-deposito-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-all">
                                Depositar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-6 border-t border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Últimos Movimientos</h4>
                    <ul id="caja-log" class="space-y-2 max-h-48 overflow-y-auto">
                        <li class="text-center text-gray-500 py-4">Cargando movimientos...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ****** NUEVO: VISTA RESUMEN ANUAL (Oculta) ****** -->
        <div id="summary-view" class="hidden">
            <!-- Header -->
            <div class="flex items-center mb-4">
                <button id="backToMenuFromSummaryBtn" class="text-gray-500 hover:text-gray-900 text-3xl font-bold transition-all self-start p-2 -ml-2">
                    &larr;
                </button>
                <h2 class="text-3xl font-bold text-gray-900 text-center flex-1 ml-4">
                    Resumen Anual
                </h2>
            </div>
            <!-- Cuerpo del Resumen -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <!-- Total General -->
                <div class="p-6 text-center bg-gray-800 text-white rounded-t-2xl">
                    <p class="text-sm font-medium text-gray-300 uppercase">Ganancia Neta (Año)</p>
                    <p id="summary-total-neto" class="text-4xl font-bold">$0.00</p>
                </div>
                <!-- Lista de Meses -->
                <ul id="summary-list" class="p-4 md:p-6">
                    <li class="text-center text-gray-500 py-8">Cargando resumen...</li>
                </ul>
            </div>
        </div>

    </div> <!-- Fin App Container -->

    <!-- MODAL 1: GASTOS DETALLADOS -->
    <div id="item-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Detalle del Gasto</h3>
                <p id="modal-subtitle" class="text-sm text-gray-500">Escribe cada item en una línea (ej: Carne 250)</p>
            </div>
            <div class="p-6">
                <textarea id="modal-textarea" rows="8" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="Leche 50.50&#10;Pan 22&#10;Verdura 130"></textarea>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="modal-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cerrar
                </button>
                <button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Guardar y Calcular
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL 2: CAJA DE AHORRO -->
    <div id="caja-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="caja-modal-title" class="text-xl font-semibold text-gray-900">
                    Realizar Movimiento
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="caja-modal-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto</label>
                    <input type="number" id="caja-modal-monto" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    <p id="caja-modal-error" class="text-sm text-red-600 mt-1 hidden">Fondos insuficientes</p>
                </div>
                <div>
                    <label for="caja-modal-concepto" class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                    <input type="text" id="caja-modal-concepto" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-500 focus:border-blue-500" placeholder="(Ej: Ahorro Semana 1)">
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="caja-modal-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cancelar
                </button>
                <button id="caja-modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- 4. TODO EL CÓDIGO JAVASCRIPT (AHORA COMO MÓDULO) -->
    <script type="module">
        // --- IMPORTS DE FIREBASE (AÑADIDOS GETDOCS Y WHERE) ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, runTransaction, 
            collection, onSnapshot, query, orderBy, limit, serverTimestamp, addDoc,
            getDocs, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRq70PInWyj7pjYPGGqMQWaVe_tbrwebI",
            authDomain: "mi-control-financiero-9099a.firebaseapp.com",
            projectId: "mi-control-financiero-9099a",
            storageBucket: "mi-control-financiero-9099a.firebasestorage.app",
            messagingSenderId: "275253747474",
            appId: "1:275253747474:web:79d7e7edeacd4d57799dcb"
        };
        
        let app, auth, db, userId;
        
        let cajaDocRef, cajaLogColRef, registrosColRef;
        let saldoActualGlobal = 0;
        let tipoMovimientoActual = 'deposito'; 
        
        // setLogLevel('Debug'); 

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = initializeApp(firebaseConfig); 
                auth = getAuth(app);
                db = getFirestore(app);

                await new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            // Definir rutas principales
                            cajaDocRef = doc(db, 'usuarios', userId, 'ahorro', 'caja');
                            cajaLogColRef = collection(db, 'usuarios', userId, 'ahorro', 'caja', 'movimientos');
                            registrosColRef = collection(db, 'usuarios', userId, 'registros');
                            resolve();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (authError) {
                                console.error("Error signing in anonymously:", authError);
                                reject(authError);
                            }
                        }
                    }, (error) => {
                        console.error("Auth error:", error);
                        reject(error);
                    });
                });

                initializeAppLogic();

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                alert("Error fatal: No se pudo conectar a la base de datos. " + error.message);
            }
        });

        // --- TODA LA LÓGICA DE LA APP ---
        function initializeAppLogic() {
            // --- SELECCIÓN DE ELEMENTOS DEL DOM (GENERAL) ---
            const mainMenu = document.getElementById('main-menu');
            const registerView = document.getElementById('register-view');
            const summaryView = document.getElementById('summary-view'); // Nuevo
            const goToRegisterBtn = document.getElementById('goToRegisterBtn');
            const goToSummaryBtn = document.getElementById('goToSummaryBtn'); // Nuevo
            const backToMenuBtn = document.getElementById('backToMenuBtn');
            const backToMenuFromSummaryBtn = document.getElementById('backToMenuFromSummaryBtn'); // Nuevo
            
            // --- DOM (GRID) ---
            const monthSelect = document.getElementById('month-select');
            const gridWrapper = document.getElementById('grid-wrapper');
            const gridHeader = document.getElementById('grid-header');
            const gridBody = document.getElementById('grid-body');
            const sueldoRow = document.getElementById('sueldo-row');
            const addRowBtn = document.getElementById('add-row-btn');
            const totalsGastosRow = document.getElementById('totals-gastos-row');
            const totalsRestanteRow = document.getElementById('totals-restante-row');
            const saveStatusEl = document.getElementById('save-status');

            // --- DOM (Modal Gasto) ---
            const itemModal = document.getElementById('item-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalTextarea = document.getElementById('modal-textarea');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            let currentModalInput = null; 

            // --- DOM (Caja de Ahorro) ---
            const cajaSaldoEl = document.getElementById('caja-saldo');
            const cajaLogEl = document.getElementById('caja-log');
            const cajaDepositoBtn = document.getElementById('caja-deposito-btn');
            const cajaRetiroBtn = document.getElementById('caja-retiro-btn');

            // --- DOM (Modal Caja) ---
            const cajaModal = document.getElementById('caja-modal');
            const cajaModalTitle = document.getElementById('caja-modal-title');
            const cajaModalMonto = document.getElementById('caja-modal-monto');
            const cajaModalConcepto = document.getElementById('caja-modal-concepto');
            const cajaModalError = document.getElementById('caja-modal-error');
            const cajaModalCloseBtn = document.getElementById('caja-modal-close-btn');
            const cajaModalSaveBtn = document.getElementById('caja-modal-save-btn');

            // --- DOM (Resumen Anual) ---
            const summaryList = document.getElementById('summary-list');
            const summaryTotalNeto = document.getElementById('summary-total-neto');

            // --- CONSTANTES ---
            const AÑO_ACTUAL = new Date().getFullYear();
            const MESES = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];
            const MES_ABREVIADO = [
                "ene", "feb", "mar", "abr", "may", "jun", 
                "jul", "ago", "sep", "oct", "nov", "dic"
            ];
            // --- NUEVO: COLORES DE MES ---
            const MES_COLORES = [
                'bg-blue-600',    // Enero (Invierno)
                'bg-red-600',     // Febrero (San Valentín)
                'bg-yellow-500',  // Marzo (Primavera)
                'bg-green-500',   // Abril (Pascua)
                'bg-pink-500',    // Mayo (Madres)
                'bg-cyan-500',    // Junio (Verano)
                'bg-orange-600',  // Julio (Verano)
                'bg-amber-600',   // Agosto (Verano)
                'bg-green-700',   // Septiembre (Patrio)
                'bg-orange-800',  // Octubre (Halloween)
                'bg-purple-700',  // Noviembre (Día de Muertos)
                'bg-red-700'      // Diciembre (Navidad)
            ];

            let saveTimeout; 

            // --- LÓGICA DE NAVEGACIÓN ---
            goToRegisterBtn.addEventListener('click', () => {
                mainMenu.classList.add('hidden');
                summaryView.classList.add('hidden');
                registerView.classList.remove('hidden');
            });
            
            goToSummaryBtn.addEventListener('click', () => {
                mainMenu.classList.add('hidden');
                registerView.classList.add('hidden');
                summaryView.classList.remove('hidden');
                cargarResumenAnual(); // Cargar datos al entrar
            });

            backToMenuBtn.addEventListener('click', () => {
                registerView.classList.add('hidden');
                summaryView.classList.add('hidden');
                mainMenu.classList.remove('hidden');
            });

            backToMenuFromSummaryBtn.addEventListener('click', () => {
                registerView.classList.add('hidden');
                summaryView.classList.add('hidden');
                mainMenu.classList.remove('hidden');
            });

            // --- LÓGICA PRINCIPAL DEL REGISTRO (GRID) ---

            function popularMeses() {
                const mesActual = new Date().getMonth();
                MESES.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = mes;
                    if (index === mesActual) {
                        option.selected = true;
                    }
                    option.className = "bg-white text-gray-900 text-base font-normal normal-case tracking-normal";
                    monthSelect.appendChild(option);
                });
            }
            
            // --- NUEVO: Función para cambiar color del banner ---
            function setBannerColor(mesIndex) {
                const colorClase = MES_COLORES[mesIndex];
                // Quitar todos los colores anteriores
                MES_COLORES.forEach(c => monthSelect.classList.remove(c));
                // Añadir el nuevo
                monthSelect.classList.add(colorClase);
            }

            function getThursdays(mes, año) {
                const mesNumero = parseInt(mes, 10);
                let thursdays = [];
                let date = new Date(año, mesNumero, 1);
                while (date.getDay() !== 4) { date.setDate(date.getDate() + 1); }
                while (date.getMonth() === mesNumero) {
                    thursdays.push(new Date(date));
                    date.setDate(date.getDate() + 7);
                }
                return thursdays;
            }
            
            function formatDate(date) {
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = MES_ABREVIADO[date.getMonth()];
                return `${dia}-${mes}`;
            }

            async function dibujarGrid(mesIndex) {
                saveStatusEl.textContent = "Cargando mes...";
                const mesNum = parseInt(mesIndex, 10);
                
                // --- NUEVO: Aplicar color de banner ---
                setBannerColor(mesNum);

                const thursdays = getThursdays(mesNum, AÑO_ACTUAL);
                const numSemanas = thursdays.length;
                
                gridWrapper.dataset.weeks = numSemanas;

                // --- IMPORTANTE: CORRECCIÓN DE DOC ID ---
                const docId = `${AÑO_ACTUAL}-${String(mesNum).padStart(2, '0')}`; // Ej: "2025-04" para Mayo
                const docRef = doc(registrosColRef, docId); // Usar la colección base
                
                let docData = null;
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        docData = docSnap.data();
                    }
                } catch (e) {
                    console.error("Error cargando datos: ", e);
                    saveStatusEl.textContent = "Error al cargar ❌";
                }

                // 1. Dibujar Encabezado
                let headerHTML = '<div class="p-2 sticky left-0 bg-gray-200 z-10">Concepto</div>';
                for (let i = 0; i < 5; i++) {
                    const date = thursdays[i];
                    const label = date ? formatDate(date) : "---";
                    const weekClass = (i === 4) ? 'week-5' : '';
                    headerHTML += `<div class="text-center p-2 ${weekClass}">${label}</div>`;
                }
                gridHeader.innerHTML = headerHTML;

                // 2. Dibujar Cuerpo
                const gastosAnteriores = gridBody.querySelectorAll('[data-row-type="gasto"]');
                gastosAnteriores.forEach(gasto => gasto.remove());

                sueldoRow.className = `grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white rounded-lg`;
                let sueldoHTML = '<div class="font-semibold text-green-700 p-2 sticky left-0 z-5 bg-white">Sueldo</div>';
                
                for (let i = 0; i < 5; i++) {
                    const sueldoValor = docData?.sueldo?.[i] || ""; 
                    const weekClass = (i === 4) ? 'week-5' : '';
                    sueldoHTML += `<input type="number" value="${sueldoValor}" placeholder="0.00" step="0.01" data-name="sueldo-input" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right focus:ring-blue-500 focus:border-blue-500 font-mono font-bold text-base ${weekClass}">`;
                }
                sueldoRow.innerHTML = sueldoHTML;
                
                if (docData && docData.gastos && docData.gastos.length > 0) {
                    docData.gastos.forEach(gasto => {
                        agregarFilaDeGasto(gasto.concepto, gasto.montos, gasto.detalles);
                    });
                } else {
                    agregarFilaDeGasto(); 
                }

                // 3. Dibujar Pie (Totales)
                let totalGastoHTML = '<div class="p-2 sticky left-0 bg-gray-50 z-10">Total Gastos</div>';
                let totalRestanteHTML = '<div class="p-2 sticky left-0 bg-gray-50 z-10">Restante</div>';
                for (let i = 0; i < 5; i++) {
                    const weekClass = (i === 4) ? 'week-5' : '';
                    totalGastoHTML += `<div class="text-center font-mono p-2 bg-blue-100 rounded text-base ${weekClass}">$0.00</div>`;
                    totalRestanteHTML += `<div class="text-center font-mono p-2 bg-white border border-gray-200 rounded font-bold text-base ${weekClass}">$0.00</div>`;
                }
                totalsGastosRow.innerHTML = totalGastoHTML;
                totalsRestanteRow.innerHTML = totalRestanteHTML;
                
                calcularTotales();
                saveStatusEl.textContent = "Listo ✔";
            }

            function agregarFilaDeGasto(concepto = "", montos = [], detalles = []) {
                const gastoRow = document.createElement('div');
                gastoRow.className = `grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white border border-gray-200 rounded-lg`;
                gastoRow.dataset.rowType = "gasto";
                gastoRow.dataset.detalles = JSON.stringify(detalles.length ? detalles : ["","","","",""]);

                let gastoHTML = `
                    <div class="sticky left-0 z-5 flex items-center gap-2 bg-white pr-2">
                        <input type="text" value="${concepto}" placeholder="Concepto de gasto..." class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500 text-base">
                        <button class="delete-gasto-btn text-red-400 hover:text-red-600 p-1 rounded-full transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>`;
                
                for (let i = 0; i < 5; i++) {
                    const montoValor = montos[i] || ""; 
                    const weekClass = (i === 4) ? 'week-5' : '';
                    gastoHTML += `<input type="number" value="${montoValor}" placeholder="0.00" step="0.01" data-name="gasto-input" readonly class="bg-yellow-100 border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right focus:ring-blue-500 focus:border-blue-500 font-mono text-base cursor-pointer hover:bg-yellow-200 ${weekClass}">`;
                }
                gastoRow.innerHTML = gastoHTML;
                gridBody.appendChild(gastoRow);
            }

            function calcularTotales() {
                const numSemanas = 5; 
                const sueldoInputs = sueldoRow.querySelectorAll('[data-name="sueldo-input"]');
                const filasGastos = gridBody.querySelectorAll('[data-row-type="gasto"]');

                let totalesSueldo = new Array(numSemanas).fill(0);
                let totalesGasto = new Array(numSemanas).fill(0);
                let totalesRestante = new Array(numSemanas).fill(0);

                sueldoInputs.forEach((input, index) => {
                    totalesSueldo[index] = parseFloat(input.value) || 0;
                });
                filasGastos.forEach(fila => {
                    const gastoInputs = fila.querySelectorAll('[data-name="gasto-input"]');
                    gastoInputs.forEach((input, index) => {
                        totalesGasto[index] += parseFloat(input.value) || 0;
                    });
                });
                for (let i = 0; i < numSemanas; i++) {
                    totalesRestante[i] = totalesSueldo[i] - totalesGasto[i];
                }

                const celdasTotalGasto = totalsGastosRow.querySelectorAll('div:not(:first-child)');
                const celdasTotalRestante = totalsRestanteRow.querySelectorAll('div:not(:first-child)');

                celdasTotalGasto.forEach((celda, index) => {
                    celda.textContent = `$${totalesGasto[index].toFixed(2)}`;
                });
                celdasTotalRestante.forEach((celda, index) => {
                    celda.textContent = `$${totalesRestante[index].toFixed(2)}`;
                    celda.classList.toggle('text-green-600', totalesRestante[index] >= 0);
                    celda.classList.toggle('text-red-600', totalesRestante[index] < 0);
                });
            }

            function triggerSave() {
                saveStatusEl.textContent = "Sincronizando...";
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(guardarDatos, 1500);
            }

            async function guardarDatos() {
                saveStatusEl.textContent = "Guardando...";
                const mesIndex = monthSelect.value;
                
                // --- IMPORTANTE: CORRECCIÓN DE DOC ID ---
                const docId = `${AÑO_ACTUAL}-${String(mesIndex).padStart(2, '0')}`;
                const docRef = doc(registrosColRef, docId);

                const sueldoInputs = sueldoRow.querySelectorAll('[data-name="sueldo-input"]');
                const sueldoData = Array.from(sueldoInputs).map(input => input.value);

                const filasGastos = gridBody.querySelectorAll('[data-row-type="gasto"]');
                const gastosData = [];
                filasGastos.forEach(fila => {
                    const conceptoInput = fila.querySelector('input[type="text"]');
                    const montoInputs = fila.querySelectorAll('[data-name="gasto-input"]');
                    const montos = Array.from(montoInputs).map(input => input.value);
                    const detalles = JSON.parse(fila.dataset.detalles || '["","","","",""]');
                    
                    if (conceptoInput.value || montos.some(m => m)) {
                        gastosData.push({
                            concepto: conceptoInput.value,
                            montos: montos,
                            detalles: detalles 
                        });
                    }
                });

                const dataPayload = {
                    sueldo: sueldoData,
                    gastos: gastosData
                };

                try {
                    await setDoc(docRef, dataPayload); 
                    saveStatusEl.textContent = "Guardado ✔";
                } catch (e) {
                    console.error("Error guardando datos: ", e);
                    saveStatusEl.textContent = "Error al guardar ❌";
                }
            }

            // --- LÓGICA DEL MODAL (GASTOS) ---

            function parseAndSum(text) {
                let total = 0;
                const lines = text.split('\n');
                for (const line of lines) {
                    const matches = line.match(/([\d\.]+)/g);
                    if (matches) {
                        total += parseFloat(matches[matches.length - 1]) || 0;
                    }
                }
                return total;
            }

            function openItemModal(input) {
                currentModalInput = input;
                const row = input.closest('[data-row-type="gasto"]');
                const concepto = row.querySelector('input[type="text"]').value || "Gasto";
                const inputs = Array.from(row.querySelectorAll('[data-name="gasto-input"]'));
                const weekIndex = inputs.indexOf(input);
                const weekLabel = document.querySelectorAll('#grid-header div')[weekIndex + 1].textContent;
                modalTitle.textContent = `Detalles: ${concepto}`;
                modalSubtitle.textContent = `Semana de ${weekLabel}`;
                const detalles = JSON.parse(row.dataset.detalles || '["","","","",""]');
                modalTextarea.value = detalles[weekIndex] || "";
                itemModal.classList.remove('hidden');
                modalTextarea.focus();
            }

            // --- LÓGICA DE CAJA DE AHORRO ---

            function iniciarListenersCaja() {
                onSnapshot(cajaDocRef, (doc) => {
                    if (doc.exists()) {
                        saldoActualGlobal = doc.data().saldoActual || 0;
                    } else {
                        setDoc(cajaDocRef, { saldoActual: 0 })
                            .catch(e => console.error("Error inicializando caja:", e));
                        saldoActualGlobal = 0;
                    }
                    cajaSaldoEl.textContent = `$${saldoActualGlobal.toFixed(2)}`;
                });

                const logQuery = query(cajaLogColRef, orderBy("fecha", "desc"), limit(10));
                onSnapshot(logQuery, (snapshot) => {
                    cajaLogEl.innerHTML = ""; 
                    if (snapshot.empty) {
                        cajaLogEl.innerHTML = '<li class="text-center text-gray-500">No hay movimientos.</li>';
                        return;
                    }
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const monto = data.monto.toFixed(2);
                        const tipo = data.tipo;
                        const fecha = data.fecha ? data.fecha.toDate().toLocaleDateString('es-MX', { day: '2-digit', month: 'short' }) : '...';
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <p class="log-concepto">${data.concepto || tipo}</p>
                                <p class="log-fecha">${fecha}</p>
                            </div>
                            <span class="log-monto ${tipo} font-bold font-mono">
                                ${tipo === 'deposito' ? '+' : '-'}$${monto}
                            </span>
                        `;
                        cajaLogEl.appendChild(li);
                    });
                });
            }

            function openCajaModal(tipo) {
                tipoMovimientoActual = tipo;
                cajaModal.classList.remove('hidden');
                cajaModalMonto.value = "";
                cajaModalConcepto.value = "";
                cajaModalError.classList.add('hidden');
                cajaModalSaveBtn.disabled = false;
                if (tipo === 'deposito') {
                    cajaModalTitle.textContent = "Depositar en Ahorros";
                    cajaModalSaveBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base";
                } else {
                    cajaModalTitle.textContent = "Retirar de Ahorros";
                    cajaModalSaveBtn.className = "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base";
                }
                cajaModalMonto.focus();
            }

            async function handleCajaSave() {
                const monto = parseFloat(cajaModalMonto.value) || 0;
                let concepto = cajaModalConcepto.value || (tipoMovimientoActual === 'deposito' ? 'Depósito' : 'Retiro');
                if (monto <= 0) {
                    cajaModalError.textContent = "El monto debe ser positivo";
                    cajaModalError.classList.remove('hidden');
                    return;
                }
                if (tipoMovimientoActual === 'retiro' && monto > saldoActualGlobal) {
                    cajaModalError.textContent = "Fondos insuficientes";
                    cajaModalError.classList.remove('hidden');
                    return;
                }
                cajaModalSaveBtn.disabled = true;
                cajaModalSaveBtn.textContent = "Guardando...";
                try {
                    await runTransaction(db, async (transaction) => {
                        const cajaDoc = await transaction.get(cajaDocRef);
                        const saldoPrevio = cajaDoc.data().saldoActual || 0;
                        let nuevoSaldo;
                        if (tipoMovimientoActual === 'deposito') {
                            nuevoSaldo = saldoPrevio + monto;
                        } else {
                            if (saldoPrevio < monto) throw new Error("Fondos insuficientes");
                            nuevoSaldo = saldoPrevio - monto;
                        }
                        transaction.update(cajaDocRef, { saldoActual: nuevoSaldo });
                        const newLogRef = doc(cajaLogColRef); 
                        transaction.set(newLogRef, {
                            tipo: tipoMovimientoActual,
                            monto: monto,
                            concepto: concepto,
                            fecha: serverTimestamp() 
                        });
                    });
                    cajaModal.classList.add('hidden');
                } catch (e) {
                    console.error("Error en la transacción de ahorro: ", e);
                    cajaModalError.textContent = `Error: ${e.message}`;
                    cajaModalError.classList.remove('hidden');
                }
                cajaModalSaveBtn.disabled = false;
                cajaModalSaveBtn.textContent = "Confirmar";
            }

            // --- ****** NUEVO: LÓGICA RESUMEN ANUAL ****** ---

            async function cargarResumenAnual() {
                summaryList.innerHTML = '<li class="text-center text-gray-500 py-8">Calculando resumen...</li>';
                
                // Query para traer todos los docs del año
                const q = query(registrosColRef, 
                    where(doc(registrosColRef).id, '>=', `${AÑO_ACTUAL}-00`), 
                    where(doc(registrosColRef).id, '<=', `${AÑO_ACTUAL}-11`)
                );
                
                let granTotalNeto = 0;
                // Inicializar un array para los 12 meses
                let mesesData = new Array(12).fill(null);

                try {
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach(doc => {
                        const docId = doc.id; // Ej: "2025-05"
                        const mesIndex = parseInt(docId.split('-')[1], 10); // Ej: 5
                        const data = doc.data();

                        // Calcular totales del mes
                        const totalSueldoMes = data.sueldo.reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                        const totalGastoMes = data.gastos.reduce((acc, gasto) => {
                            return acc + gasto.montos.reduce((a, m) => a + (parseFloat(m) || 0), 0);
                        }, 0);
                        
                        const totalNetoMes = totalSueldoMes - totalGastoMes;
                        granTotalNeto += totalNetoMes;

                        // Guardar en el array en la posición correcta
                        mesesData[mesIndex] = {
                            totalSueldoMes,
                            totalGastoMes,
                            totalNetoMes
                        };
                    });

                    // Renderizar los datos
                    summaryList.innerHTML = ""; // Limpiar
                    MESES.forEach((mesNombre, index) => {
                        const data = mesesData[index];
                        const li = document.createElement('li');
li.className = "summary-item";

                        if (data) {
                            const netoColor = data.totalNetoMes >= 0 ? 'text-green-600' : 'text-red-600';
                            li.innerHTML = `
                                <div>
                                    <p class="text-lg font-bold text-gray-900">${mesNombre}</p>
                                    <p class="text-sm text-gray-500">Sueldo: $${data.totalSueldoMes.toFixed(2)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold font-mono ${netoColor}">$${data.totalNetoMes.toFixed(2)}</p>
                                    <p class="text-sm text-gray-500">Gasto: $${data.totalGastoMes.toFixed(2)}</p>
                                </div>
                            `;
                        } else {
                            // Mes sin datos
                            li.innerHTML = `
                                <div>
                                    <p class="text-lg font-bold text-gray-400">${mesNombre}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-mono text-gray-400">Sin datos</p>
                                </div>
                            `;
                        }
                        summaryList.appendChild(li);
                    });

                    // Actualizar Gran Total
                    summaryTotalNeto.textContent = `$${granTotalNeto.toFixed(2)}`;
                    summaryTotalNeto.classList.toggle('text-green-400', granTotalNeto >= 0);
                    summaryTotalNeto.classList.toggle('text-red-400', granTotalNeto < 0);

                } catch (e) {
                    console.error("Error cargando resumen anual: ", e);
                    summaryList.innerHTML = '<li class="text-center text-red-500 py-8">Error al cargar resumen.</li>';
                }
            }

            // --- INICIALIZACIÓN DE LA APP ---
            popularMeses();
            dibujarGrid(monthSelect.value); // Llama inicial
            iniciarListenersCaja(); 

            // --- EVENT LISTENERS (GRID) ---
            monthSelect.addEventListener('change', (e) => {
                dibujarGrid(e.target.value); 
            });
            
            addRowBtn.addEventListener('click', () => {
                agregarFilaDeGasto();
                triggerSave(); 
            });
            
            gridBody.addEventListener('input', (e) => {
                if(e.target.tagName === 'INPUT') {
                    if (e.target.dataset.name === 'sueldo-input' || e.target.type === 'text') {
                        calcularTotales(); 
                        triggerSave();    
                    }
                }
            });

            gridBody.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-gasto-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('[data-row-type="gasto"]');
                    row.remove();
                    calcularTotales();
                    triggerSave();
                    return; 
                }
                const gastoInput = e.target.closest('[data-name="gasto-input"]');
                if (gastoInput) {
                    openItemModal(gastoInput);
                }
            });

            // --- Listeners Modal Gasto ---
            modalCloseBtn.addEventListener('click', () => {
                itemModal.classList.add('hidden');
                currentModalInput = null;
            });

            modalSaveBtn.addEventListener('click', () => {
                if (!currentModalInput) return;
                const text = modalTextarea.value;
                const sum = parseAndSum(text);
                currentModalInput.value = sum.toFixed(2);
                const row = currentModalInput.closest('[data-row-type="gasto"]');
                const inputs = Array.from(row.querySelectorAll('[data-name="gasto-input"]'));
                const weekIndex = inputs.indexOf(currentModalInput);
                let detalles = JSON.parse(row.dataset.detalles || '["","","","",""]');
                detalles[weekIndex] = text;
                row.dataset.detalles = JSON.stringify(detalles);
                itemModal.classList.add('hidden');
                currentModalInput = null;
                calcularTotales();
                triggerSave();
            });

            // --- Listeners Modal Caja ---
            cajaDepositoBtn.addEventListener('click', () => openCajaModal('deposito'));
            cajaRetiroBtn.addEventListener('click', () => openCajaModal('retiro'));

            cajaModalCloseBtn.addEventListener('click', () => {
                cajaModal.classList.add('hidden');
            });

            cajaModalSaveBtn.addEventListener('click', handleCajaSave);

            cajaModalMonto.addEventListener('input', () => {
                const monto = parseFloat(cajaModalMonto.value) || 0;
                if (tipoMovimientoActual === 'retiro' && monto > saldoActualGlobal) {
                    cajaModalError.textContent = "Fondos insuficientes";
                    cajaModalError.classList.remove('hidden');
                    cajaModalSaveBtn.disabled = true;
                } else {
                    cajaModalError.classList.add('hidden');
                    cajaModalSaveBtn.disabled = false;
                }
            });
        }
    </script>
</body>
</html>