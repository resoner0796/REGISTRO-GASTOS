<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Control de Gastos (Splash Pro)</title>
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#10B981">

<!-- iOS support -->
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .horizontal-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #grid-wrapper[data-weeks="4"] .week-5 { display: none; }
        input[type="number"], input[type="text"], textarea { font-size: 16px !important; }
        /* Estilos para logs y listas */
        #caja-log li, #gastos-fijos-lista li, #metas-lista li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #e5e7eb;
        }
        #caja-log li:last-child, #gastos-fijos-lista li:last-child, #metas-lista li:last-child { border-bottom: none; }
        #caja-log .log-concepto, #gastos-fijos-lista .log-concepto { font-size: 0.9rem; }
        #caja-log .log-fecha { font-size: 0.75rem; color: #6b7280; }
        #caja-log .log-monto.deposito { color: #16a34a; }
        #caja-log .log-monto.retiro { color: #dc2626; }
        #gastos-fijos-lista .log-monto { color: #dc2626; }
        /* Estilos Resumen */
        #summary-list .summary-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid #e5e7eb;
        }
        /* Hacer clickables los conceptos */
        #summary-category-list li { cursor: pointer; transition: background-color 0.1s; }
        #summary-category-list li:hover { background-color: #f9fafb; /* gray-50 */ }
        
        #summary-list .summary-item:last-child { border-bottom: none; }
        /* Estilos Tab Bar */
        .tab-button.active { color: #2563eb; }
        /* Estilos Toggle Resumen */
        .summary-toggle { display: flex; border-radius: 9999px; background-color: #e5e7eb; padding: 4px; }
        .summary-toggle button {
            border-radius: 9999px; padding: 6px 16px; font-weight: 500;
            color: #6b7280; transition: all 0.2s ease-in-out;
            outline: none; border: none; background-color: transparent;
        }
        .summary-toggle button.active {
            background-color: #ffffff; color: #111827;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Estilos para fila planeada */
        .gasto-planeado { background-color: #f3f4f6; opacity: 0.8; border-style: dashed; }
        .gasto-planeado input[type="text"] { background-color: #f3f4f6; font-style: italic; }
        .gasto-planeado .monto-planeado { background-color: #e5e7eb; color: #4b5563; font-style: italic; cursor: default !important; }
        
        /* Estilos Metas de Ahorro */
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; }
        .progress-bar-inner {
            background-color: #22c55e; /* green-500 */
            height: 100%; transition: width 0.5s ease-in-out;
        }
        
        /* <<<--- INICIO: Estilos Splash Screen --- */
        #splash-screen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #111827; /* gray-900 */
            color: white;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen.splash-hidden {
            opacity: 0;
            pointer-events: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        #splash-screen .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* <<<--- FIN: Estilos Splash Screen --- */
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen antialiased">

    <!-- <<<--- INICIO: Splash Screen Mamalón --- */ -->
    <div id="splash-screen">
        <!-- Ícono de "Banknotes" Mamalón (Sólido) -->
        <svg class="w-24 h-24 text-green-400 animate-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 1v22" />
  <path d="M17 5c0-2-2.5-3-5-3s-5 1-5 3 2.5 3 5 3 5 1 5 3-2.5 3-5 3-5-1-5-3" />
</svg>
        <h1 class="text-3xl font-bold mt-4">Control de Gastos</h1>
        <p class="text-gray-400 text-lg mt-2">Conectando...</p>
    </div>
    <!-- <<<--- FIN: Splash Screen Mamalón --- */ -->


    <!-- Contenedor principal de la App -->
    <div id="app-container" class="container mx-auto max-w-6xl p-4 md:p-8 pb-24">

        <!-- VISTA: Registro de Gastos (Visible por defecto) -->
        <div id="register-view" class="">
            <!-- SELECTOR DE MES -->
            <select id="month-select" class="w-full text-white p-3 text-center text-3xl font-extrabold tracking-widest uppercase appearance-none rounded-t-2xl shadow-lg focus:outline-none cursor-pointer transition-colors duration-300">
                <!-- Opciones de mes -->
            </select>
            <!-- Contenedor del Grid -->
            <div class="bg-white rounded-b-2xl shadow-xl overflow-hidden">
                <div class="horizontal-scroll">
                    <div id="grid-wrapper" class="min-w-[800px] md:min-w-full" data-weeks="5">
                        <!-- Encabezado del Grid -->
                        <div id="grid-header" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] bg-gray-200 p-4 font-bold sticky top-0 z-10 gap-2 text-base"></div>
                        <!-- Cuerpo del Grid -->
                        <div id="grid-body" class="p-4 space-y-2">
                            <div id="sueldo-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white rounded-lg" data-row-type="sueldo"></div>
                        </div>
                        <!-- Pie de página del Grid (Totales) -->
                        <div id="grid-footer" class="bg-gray-50 p-4 space-y-2 sticky bottom-0 z-10 border-t border-gray-200">
                            <div id="totals-gastos-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center font-bold text-gray-700"></div>
                            <div id="totals-restante-row" class="grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center font-bold"></div>
                        </div>
                    </div>
                </div>
                <!-- Botones de Acción -->
                <div class="bg-white p-4 border-t border-gray-200 flex justify-between items-center">
                    <button id="add-row-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all text-base">
                        + Agregar Gasto
                    </button>
                    <span id="save-status" class="text-sm text-gray-500 font-medium">Listo ✔</span>
                </div>
            </div>
        </div>

        <!-- VISTA RESUMEN ANUAL (Oculta) -->
        <div id="summary-view" class="hidden">
            <!-- Header Limpio -->
            <div class="bg-white p-4 rounded-t-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-900 text-center">
                    Resumen
                </h2>
                <!-- NUEVO: Filtro de Mes -->
                <div class="mt-4">
                    <select id="resumen-month-filter" class="w-full border border-gray-300 rounded-lg p-2 text-base focus:ring-blue-500 focus:border-blue-500">
                        <option value="annual">Todo el Año</option>
                        <!-- Se llena con JS -->
                    </select>
                </div>
                <!-- Toggle de vista -->
                <div class="flex justify-center mt-4">
                    <div class="summary-toggle">
                        <button id="toggle-lista" class="active">Lista</button>
                        <button id="toggle-grafica">Gráfica</button>
                    </div>
                </div>
            </div>
            
            <!-- Cuerpo del Resumen -->
            <div class="bg-white rounded-b-2xl shadow-xl overflow-hidden">
                <!-- VISTA 1: Lista (Default) -->
                <div id="summary-lista-view">
                    <!-- Total General -->
                    <div class="p-6 text-center bg-gray-800 text-white">
                        <p id="summary-total-title" class="text-sm font-medium text-gray-300 uppercase">Balance Neto (Año)</p>
                        <p id="summary-total-neto" class="text-4xl font-bold">$0.00</p>
                        <div class="flex justify-center gap-6 text-sm mt-4 text-gray-300">
                           <div>
                               <span class="font-medium">Total Ganado</span>
                               <p id="summary-total-ganado" class="font-bold text-green-400">$0.00</p>
                           </div>
                           <div>
                               <span class="font-medium">Total Gastado</span>
                               <p id="summary-total-gastado" class="font-bold text-red-400">$0.00</p>
                           </div>
                        </div>
                    </div>
                    <!-- Lista de Meses (SOLO VISIBLE EN VISTA ANUAL) -->
                    <ul id="summary-list" class="p-4 md:p-6">
                        <li class="text-center text-gray-500 py-8">Cargando resumen...</li>
                    </ul>
                    <!-- Sección Gastos por Concepto -->
                    <div class="p-4 md:p-6 border-t border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Gastos por Concepto</h3>
                        <p class="text-sm text-gray-500 -mt-2 mb-4">Haz click en un concepto para ver la tendencia.</p>
                        <ul id="summary-category-list" class="space-y-3 max-h-72 overflow-y-auto">
                            <li class="text-center text-gray-500 py-4">Calculando...</li>
                        </ul>
                    </div>
                </div>
                <!-- VISTA 2: Gráfica (Oculta) -->
                <div id="summary-grafica-view" class="hidden p-4 md:p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Gastos por Concepto</h3>
                    <div class="relative w-full max-w-md mx-auto h-72 md:h-96">
                        <canvas id="gastos-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VISTA CAJA DE AHORRO (Oculta) -->
        <div id="caja-view" class="hidden space-y-6">
            <!-- Header Limpio -->
            <div class="bg-white p-4 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-900 text-center">
                    Caja de Ahorro
                </h2>
            </div>
            
            <!-- Panel de Saldos (MODIFICADO) -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Saldo Total -->
                    <div class="text-center md:text-left border-b md:border-b-0 md:border-r pb-6 md:pb-0 md:pr-6 border-gray-200">
                        <p class="text-sm font-medium text-gray-500 uppercase">Saldo Total en Caja</p>
                        <p id="caja-saldo" class="text-4xl font-bold text-green-600">$0.00</p>
                    </div>
                    <!-- Saldo Disponible -->
                    <div class="text-center md:text-left">
                        <p class="text-sm font-medium text-gray-500 uppercase">Saldo Disponible (Sin Asignar)</p>
                        <p id="caja-disponible" class="text-4xl font-bold text-gray-800">$0.00</p>
                    </div>
                </div>
                <div class="flex gap-3 justify-center mt-6">
                    <button id="caja-retiro-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-all">
                        Retirar
                    </button>
                    <button id="caja-deposito-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-all">
                        Depositar
                    </button>
                </div>
            </div>
            
            <!-- NUEVO: Panel de Metas de Ahorro -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">Mis Metas de Ahorro</h3>
                    <button id="nueva-meta-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all text-base">
                        + Nueva Meta
                    </button>
                </div>
                <div class="p-6">
                    <ul id="metas-lista" class="space-y-4">
                        <li class="text-center text-gray-500">Cargando metas...</li>
                    </ul>
                </div>
            </div>

            <!-- Panel de Movimientos -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gray-50 p-6 border-t border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Últimos Movimientos (Caja)</h4>
                    <ul id="caja-log" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <li class="text-center text-gray-500 py-4">Cargando movimientos...</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- VISTA AJUSTES (Oculta) -->
        <div id="ajustes-view" class="hidden">
            <!-- Header Limpio -->
            <div class="bg-white p-4 rounded-t-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-900 text-center">
                    Ajustes
                </h2>
            </div>
            <!-- Panel de Gastos Fijos -->
            <div class="bg-white rounded-b-2xl shadow-xl overflow-hidden">
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Gastos Fijos (Piloto Automático)</h3>
                    <p class="text-gray-600 mb-4 text-sm">
                        Agrega gastos que se repiten cada mes. Aparecerán como un recordatorio en tu tabla mensual.
                    </p>
                    <form id="gasto-fijo-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                        <div class="md:col-span-2">
                            <label for="gasto-fijo-concepto" class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                            <input type="text" id="gasto-fijo-concepto" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Netflix" required>
                        </div>
                        <div>
                            <label for="gasto-fijo-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto</label>
                            <input type="number" id="gasto-fijo-monto" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="gasto-fijo-dia" class="block text-sm font-medium text-gray-700 mb-1">Día de Pago (1-31)</label>
                            <input type="number" id="gasto-fijo-dia" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: 15" min="1" max="31" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-all">
                                Agregar Gasto Fijo
                            </button>
                        </div>
                    </form>
                </div>
                <div class="bg-gray-50 p-6 border-t border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Mis Gastos Fijos</h4>
                    <ul id="gastos-fijos-lista" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <li class="text-center text-gray-500 py-4">Cargando gastos...</li>
                    </ul>
                </div>
            </div>
        </div>

    </div> <!-- Fin App Container -->

    <!-- TAB BAR FIJA (CON 4 TABS) -->
    <nav class="fixed bottom-0 left-0 right-0 w-full bg-white border-t border-gray-200 shadow-t-lg z-50 flex justify-around">
        <button id="tab-registro" class="tab-button flex-1 flex flex-col items-center justify-center p-3 text-blue-600 active" data-view="register-view">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            <span class="text-xs font-medium">Registro</span>
        </button>
        <button id="tab-resumen" class="tab-button flex-1 flex flex-col items-center justify-center p-3 text-gray-500" data-view="summary-view">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            <span class="text-xs font-medium">Resumen</span>
        </button>
        <button id="tab-caja" class="tab-button flex-1 flex flex-col items-center justify-center p-3 text-gray-500" data-view="caja-view">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span class="text-xs font-medium">Caja</span>
        </button>
        <!-- <<<--- INICIO DE LA CORRECCIÓN: Ícono de Ajustes "cog-6-tooth" (Engrane de 6 Dientes) -->
        <button id="tab-ajustes" class="tab-button flex-1 flex flex-col items-center justify-center p-3 text-gray-500" data-view="ajustes-view">
          <svg class="w-6 h-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="3" />
  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H10A1.65 1.65 0 0 0 11 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V10a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
</svg>
            <span class="text-xs font-medium">Ajustes</span>
        </button>
        <!-- <<<--- FIN DE LA CORRECCIÓN -->
    </nav>


    <!-- MODAL 1: GASTOS DETALLADOS -->
    <div id="item-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Detalle del Gasto</h3>
                <p id="modal-subtitle" class="text-sm text-gray-500">Escribe cada item en una línea (ej: Carne 250)</p>
            </div>
            <div class="p-6">
                <textarea id="modal-textarea" rows="8" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="Leche 50.50&#10;Pan 22&#10;Verdura 130"></textarea>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="modal-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cerrar
                </button>
                <button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Guardar y Calcular
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL 2: CAJA DE AHORRO (DEPOSITO/RETIRO) -->
    <div id="caja-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="caja-modal-title" class="text-xl font-semibold text-gray-900">
                    Realizar Movimiento
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="caja-modal-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto</label>
                    <input type="number" id="caja-modal-monto" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    <p id="caja-modal-error" class="text-sm text-red-600 mt-1 hidden">Fondos insuficientes</p>
                </div>
                <div>
                    <label for="caja-modal-concepto" class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                    <input type="text" id="caja-modal-concepto" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-500 focus:border-blue-500" placeholder="(Ej: Ahorro Semana 1)">
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="caja-modal-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cancelar
                </button>
                <button id="caja-modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- NUEVO MODAL 3: NUEVA META DE AHORRO -->
    <div id="nueva-meta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Crear Nueva Meta</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="nueva-meta-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Meta</label>
                    <input type="text" id="nueva-meta-nombre" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Moto Nueva">
                </div>
                <div>
                    <label for="nueva-meta-total" class="block text-sm font-medium text-gray-700 mb-1">Costo Total</label>
                    <input type="number" id="nueva-meta-total" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="50000.00">
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="nueva-meta-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cancelar
                </button>
                <button id="nueva-meta-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Crear Meta
                </button>
            </div>
        </div>
    </div>
    
    <!-- NUEVO MODAL 4: ABONAR A META -->
    <div id="abonar-meta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="abonar-meta-title" class="text-xl font-semibold text-gray-900">Abonar a Meta</h3>
                <p id="abonar-meta-disponible" class="text-sm text-gray-500">Saldo Disponible: $0.00</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="abonar-meta-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto a Abonar</label>
                    <input type="number" id="abonar-meta-monto" class="w-full border border-gray-300 rounded-lg p-3 text-base font-mono focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                    <p id="abonar-meta-error" class="text-sm text-red-600 mt-1 hidden">No tienes suficiente saldo disponible.</p>
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-2xl">
                <button id="abonar-meta-close-btn" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 transition-all text-base">
                    Cancelar
                </button>
                <button id="abonar-meta-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base">
                    Abonar
                </button>
            </div>
        </div>
    </div>
    
    <!-- NUEVO MODAL 5: TENDENCIA DE GASTO -->
    <div id="tendencia-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 id="tendencia-modal-title" class="text-xl font-semibold text-gray-900">Tendencia de Gasto</h3>
                <button id="tendencia-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6">
                <div class="relative w-full h-72 md:h-80">
                    <canvas id="tendencia-chart"></canvas>
                </div>
            </div>
        </div>
    </div>


    <!-- 4. TODO EL CÓDIGO JAVASCRIPT (AHORA COMO MÓDULO) -->
    <script type="module">
        // --- IMPORTS DE FIREBASE ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, runTransaction, 
            collection, onSnapshot, query, orderBy, limit, serverTimestamp, addDoc,
            getDocs, where, documentId, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRq70PInWyj7pjYPGGqMQWaVe_tbrwebI",
            authDomain: "mi-control-financiero-9099a.firebaseapp.com",
            projectId: "mi-control-financiero-9099a",
            storageBucket: "mi-control-financiero-9099a.firebasestorage.app",
            messagingSenderId: "275253747474",
            appId: "1:275253747474:web:79d7e7edeacd4d57799dcb"
        };
        
        let app, auth, db, userId;
        let cajaDocRef, cajaLogColRef, registrosColRef, gastosFijosColRef;
        let metasColRef; 
        let saldoCajaGlobal = 0; 
        let saldoDisponibleGlobal = 0; 
        let tipoMovimientoActual = 'deposito'; 
        let gastosChartInstance = null;
        let tendenciaChartInstance = null; 
        
        // setLogLevel('Debug'); 

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = initializeApp(firebaseConfig); 
                auth = getAuth(app);
                db = getFirestore(app);

                await new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            cajaDocRef = doc(db, 'usuarios', userId, 'ahorro', 'caja');
                            cajaLogColRef = collection(db, 'usuarios', userId, 'ahorro', 'caja', 'movimientos');
                            registrosColRef = collection(db, 'usuarios', userId, 'registros');
                            gastosFijosColRef = collection(db, 'usuarios', userId, 'gastos_fijos');
                            metasColRef = collection(db, 'usuarios', userId, 'ahorro', 'caja', 'metas'); // Ruta corregida
                            resolve();
                        } else {
                            try { await signInAnonymously(auth); } catch (e) { reject(e); }
                        }
                    }, (error) => reject(error));
                });
                initializeAppLogic();
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('splash-screen').innerHTML = `<h1 class="text-red-500 text-xl p-8">Error fatal: ${error.message}</h1>`;
            }
        });

        // --- TODA LA LÓGICA DE LA APP ---
        function initializeAppLogic() {
            // --- DOM (VISTAS) ---
            const registerView = document.getElementById('register-view');
            const summaryView = document.getElementById('summary-view'); 
            const cajaView = document.getElementById('caja-view');
            const ajustesView = document.getElementById('ajustes-view');
            const views = [registerView, summaryView, cajaView, ajustesView];
            // --- DOM (SPLASH) ---
            const splashScreen = document.getElementById('splash-screen');
            // --- DOM (TAB BAR) ---
            const tabRegistro = document.getElementById('tab-registro');
            const tabResumen = document.getElementById('tab-resumen');
            const tabCaja = document.getElementById('tab-caja');
            const tabAjustes = document.getElementById('tab-ajustes');
            const tabButtons = [tabRegistro, tabResumen, tabCaja, tabAjustes];
            // --- DOM (GRID) ---
            const monthSelect = document.getElementById('month-select');
            const gridWrapper = document.getElementById('grid-wrapper');
            const gridHeader = document.getElementById('grid-header');
            const gridBody = document.getElementById('grid-body');
            const sueldoRow = document.getElementById('sueldo-row');
            const addRowBtn = document.getElementById('add-row-btn');
            const totalsGastosRow = document.getElementById('totals-gastos-row');
            const totalsRestanteRow = document.getElementById('totals-restante-row');
            const saveStatusEl = document.getElementById('save-status');
            // --- DOM (Modal Gasto) ---
            const itemModal = document.getElementById('item-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalTextarea = document.getElementById('modal-textarea');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            let currentModalInput = null; 
            // --- DOM (Caja de Ahorro) ---
            const cajaSaldoEl = document.getElementById('caja-saldo');
            const cajaDisponibleEl = document.getElementById('caja-disponible'); 
            const cajaLogEl = document.getElementById('caja-log');
            const cajaDepositoBtn = document.getElementById('caja-deposito-btn');
            const cajaRetiroBtn = document.getElementById('caja-retiro-btn');
            const nuevaMetaBtn = document.getElementById('nueva-meta-btn'); 
            const metasListaEl = document.getElementById('metas-lista'); 
            // --- DOM (Modal Caja) ---
            const cajaModal = document.getElementById('caja-modal');
            const cajaModalTitle = document.getElementById('caja-modal-title');
            const cajaModalMonto = document.getElementById('caja-modal-monto');
            const cajaModalConcepto = document.getElementById('caja-modal-concepto');
            const cajaModalError = document.getElementById('caja-modal-error');
            const cajaModalCloseBtn = document.getElementById('caja-modal-close-btn');
            const cajaModalSaveBtn = document.getElementById('caja-modal-save-btn');
            // --- DOM (Modal Nueva Meta) ---
            const nuevaMetaModal = document.getElementById('nueva-meta-modal');
            const nuevaMetaNombre = document.getElementById('nueva-meta-nombre');
            const nuevaMetaTotal = document.getElementById('nueva-meta-total');
            const nuevaMetaCloseBtn = document.getElementById('nueva-meta-close-btn');
            const nuevaMetaSaveBtn = document.getElementById('nueva-meta-save-btn');
            // --- DOM (Modal Abonar Meta) ---
            const abonarMetaModal = document.getElementById('abonar-meta-modal');
            const abonarMetaTitle = document.getElementById('abonar-meta-title');
            const abonarMetaDisponible = document.getElementById('abonar-meta-disponible');
            const abonarMetaMonto = document.getElementById('abonar-meta-monto');
            const abonarMetaError = document.getElementById('abonar-meta-error');
            const abonarMetaCloseBtn = document.getElementById('abonar-meta-close-btn');
            const abonarMetaSaveBtn = document.getElementById('abonar-meta-save-btn');
            let metaActualId = null; 
            // --- DOM (Resumen Anual) ---
            const summaryList = document.getElementById('summary-list');
            const summaryTotalTitle = document.getElementById('summary-total-title');
            const summaryTotalNeto = document.getElementById('summary-total-neto');
            const summaryTotalGanado = document.getElementById('summary-total-ganado');
            const summaryTotalGastado = document.getElementById('summary-total-gastado');
            const summaryCategoryList = document.getElementById('summary-category-list');
            const resumenMonthFilter = document.getElementById('resumen-month-filter'); 
            const toggleLista = document.getElementById('toggle-lista');
            const toggleGrafica = document.getElementById('toggle-grafica');
            const summaryListaView = document.getElementById('summary-lista-view');
            const summaryGraficaView = document.getElementById('summary-grafica-view');
            const chartCanvas = document.getElementById('gastos-chart');
            // --- DOM (Modal Tendencia) ---
            const tendenciaModal = document.getElementById('tendencia-modal');
            const tendenciaModalTitle = document.getElementById('tendencia-modal-title');
            const tendenciaModalCloseBtn = document.getElementById('tendencia-modal-close-btn');
            const tendenciaChartCanvas = document.getElementById('tendencia-chart');
            // --- DOM (Ajustes) ---
            const gastoFijoForm = document.getElementById('gasto-fijo-form');
            const gastosFijosLista = document.getElementById('gastos-fijos-lista');
            // --- CONSTANTES ---
            const AÑO_ACTUAL = new Date().getFullYear();
            const MESES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const MES_ABREVIADO = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
            const MES_COLORES = ['bg-blue-600', 'bg-red-600', 'bg-yellow-500', 'bg-green-500', 'bg-pink-500', 'bg-cyan-500', 'bg-orange-600', 'bg-amber-600', 'bg-green-700', 'bg-orange-800', 'bg-purple-700', 'bg-red-700'];
            let saveTimeout; 

            // --- LÓGICA DE NAVEGACIÓN (TAB BAR) ---
            function handleTabClick(e) {
                const clickedButton = e.currentTarget;
                const viewId = clickedButton.dataset.view;
                views.forEach(view => view.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                tabButtons.forEach(button => {
                    button.classList.remove('active', 'text-blue-600');
                    button.classList.add('text-gray-500');
                });
                clickedButton.classList.add('active', 'text-blue-600');
                clickedButton.classList.remove('text-gray-500');
                if (viewId === 'summary-view') { cargarResumen(); } 
                if (viewId === 'caja-view') { iniciarListenersCaja(); } 
                window.scrollTo(0, 0);
            }
            tabButtons.forEach(button => button.addEventListener('click', handleTabClick));

            // --- LÓGICA PRINCIPAL DEL REGISTRO (GRID) ---
            function popularMeses() {
                const mesActual = new Date().getMonth();
                MESES.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = mes;
                    if (index === mesActual) { option.selected = true; }
                    option.className = "bg-white text-gray-900 text-base font-normal normal-case tracking-normal";
                    monthSelect.appendChild(option);
                    
                    const filterOption = document.createElement('option');
                    filterOption.value = index;
                    filterOption.textContent = mes;
                    resumenMonthFilter.appendChild(filterOption);
                });
            }
            function setBannerColor(mesIndex) {
                const colorClase = MES_COLORES[mesIndex];
                MES_COLORES.forEach(c => monthSelect.classList.remove(c));
                monthSelect.classList.add(colorClase);
            }
            function getThursdays(mes, año) {
                const mesNumero = parseInt(mes, 10);
                let thursdays = [];
                let date = new Date(año, mesNumero, 1);
                while (date.getDay() !== 4) { date.setDate(date.getDate() + 1); }
                while (date.getMonth() === mesNumero) {
                    thursdays.push(new Date(date));
                    date.setDate(date.getDate() + 7);
                }
                return thursdays;
            }
            function formatDate(date) {
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = MES_ABREVIADO[date.getMonth()];
                return `${dia}-${mes}`;
            }

            async function dibujarGrid(mesIndex) {
                saveStatusEl.textContent = "Cargando mes...";
                const mesNum = parseInt(mesIndex, 10);
                setBannerColor(mesNum);
                const thursdays = getThursdays(mesNum, AÑO_ACTUAL);
                const numSemanas = thursdays.length;
                gridWrapper.dataset.weeks = numSemanas;
                const docId = `${AÑO_ACTUAL}-${String(mesNum).padStart(2, '0')}`;
                const docRef = doc(registrosColRef, docId); 
                let docData = { sueldo: [], gastos: [] };
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        docData = docSnap.data();
                        if (!docData.sueldo) docData.sueldo = [];
                        if (!docData.gastos) docData.gastos = [];
                    }
                    const gastosFijosSnap = await getDocs(gastosFijosColRef);
                    const conceptosExistentes = docData.gastos.map(g => g.concepto.toLowerCase());
                    let seAgregaronNuevosGastosFijos = false;
                    
                    gastosFijosSnap.forEach(doc => {
                        const gastoFijo = doc.data();
                        const conceptoFijo = gastoFijo.concepto;
                        if (!conceptosExistentes.includes(conceptoFijo.toLowerCase())) {
                            const dia = gastoFijo.dia;
                            let weekIndex = -1;
                            for (let i = 0; i < thursdays.length; i++) {
                                const diaJueves = thursdays[i].getDate();
                                const diaLimite = (i === 0) ? 1 : thursdays[i-1].getDate() + 1;
                                if (dia >= diaLimite && dia <= diaJueves) { weekIndex = i; break; }
                            }
                            if (weekIndex === -1) { weekIndex = thursdays.length - 1; }
                            let montos = ["", "", "", "", ""];
                            montos[weekIndex] = gastoFijo.monto;
                            docData.gastos.push({
                                concepto: conceptoFijo,
                                montos: montos,
                                detalles: ["", "", "", "", ""],
                                esPlaneado: true 
                            });
                            seAgregaronNuevosGastosFijos = true;
                        }
                    });
                    
                    let headerHTML = '<div class="p-2 sticky left-0 bg-gray-200 z-10">Concepto</div>';
                    for (let i = 0; i < 5; i++) {
                        const date = thursdays[i];
                        const label = date ? formatDate(date) : "---";
                        const weekClass = (i === 4) ? 'week-5' : '';
                        headerHTML += `<div class="text-center p-2 ${weekClass}">${label}</div>`;
                    }
                    gridHeader.innerHTML = headerHTML;
                    
                    gridBody.querySelectorAll('[data-row-type="gasto"]').forEach(gasto => gasto.remove());
                    gridBody.querySelectorAll('[data-row-type="gasto-planeado"]').forEach(gasto => gasto.remove());
                    
                    sueldoRow.className = `grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white rounded-lg`;
                    let sueldoHTML = '<div class="font-semibold text-green-700 p-2 sticky left-0 z-5 bg-white">Sueldo</div>';
                    for (let i = 0; i < 5; i++) {
                        const sueldoValor = docData?.sueldo?.[i] || ""; 
                        const weekClass = (i === 4) ? 'week-5' : '';
                        sueldoHTML += `<input type="number" value="${sueldoValor}" placeholder="0.00" step="0.01" data-name="sueldo-input" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right focus:ring-blue-500 focus:border-blue-500 font-mono font-bold text-base ${weekClass}">`;
                    }
                    sueldoRow.innerHTML = sueldoHTML;
                    
                    if (docData && docData.gastos && docData.gastos.length > 0) {
                        docData.gastos.forEach(gasto => {
                            agregarFilaDeGasto(gasto.concepto, gasto.montos, gasto.detalles, gasto.esPlaneado);
                        });
                    }
                    if (gridBody.querySelectorAll('[data-row-type]').length === 0) {
                        agregarFilaDeGasto(); 
                    }

                    let totalGastoHTML = '<div class="p-2 sticky left-0 bg-gray-50 z-10">Total Gastos</div>';
                    let totalRestanteHTML = '<div class="p-2 sticky left-0 bg-gray-50 z-10">Restante</div>';
                    for (let i = 0; i < 5; i++) {
                        const weekClass = (i === 4) ? 'week-5' : '';
                        totalGastoHTML += `<div class="text-center font-mono p-2 bg-blue-100 rounded text-base ${weekClass}">$0.00</div>`;
                        totalRestanteHTML += `<div class="text-center font-mono p-2 bg-white border border-gray-200 rounded font-bold text-base ${weekClass}">$0.00</div>`;
                    }
                    totalsGastosRow.innerHTML = totalGastoHTML;
                    totalsRestanteRow.innerHTML = totalRestanteHTML;
                    calcularTotales();
                    saveStatusEl.textContent = "Listo ✔";
                    if (seAgregaronNuevosGastosFijos) { triggerSave(); }
                    
                    // <<<--- INICIO: Ocultar Splash Screen --- */
                    // Se oculta después de que la primera grilla se dibuja
                    if (splashScreen && !splashScreen.classList.contains('splash-hidden')) {
                        splashScreen.classList.add('splash-hidden');
                        setTimeout(() => { splashScreen.classList.add('hidden'); }, 500); // Ocultarlo del DOM después de la transición
                    }
                    // <<<--- FIN: Ocultar Splash Screen --- */
                    
                } catch (e) {
                    console.error("Error cargando datos: ", e);
                    saveStatusEl.textContent = "Error al cargar ❌";
                }
            }
            
            function agregarFilaDeGasto(concepto = "", montos = [], detalles = [], esPlaneado = false) {
                const gastoRow = document.createElement('div');
                let gastoHTML = '';
                if (esPlaneado) {
                    gastoRow.className = `grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white border border-gray-200 rounded-lg gasto-planeado`;
                    gastoRow.dataset.rowType = "gasto-planeado";
                    gastoRow.dataset.detalles = JSON.stringify(detalles.length ? detalles : ["","","","",""]);
                    gastoHTML = `
                        <div class="sticky left-0 z-5 flex items-center gap-1 bg-gray-100 pr-2">
                            <input type="text" value="${concepto}" placeholder="Concepto..." readonly class="border-none text-gray-900 rounded-lg p-2 w-full focus:ring-0 text-base">
                            <button class="confirm-gasto-btn text-green-500 hover:text-green-700 p-1 rounded-full transition-all" title="Confirmar pago">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                            <button class="delete-gasto-btn text-red-400 hover:text-red-600 p-1 rounded-full transition-all" title="Borrar recordatorio">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>`;
                    for (let i = 0; i < 5; i++) {
                        const montoValor = montos[i] || ""; 
                        const weekClass = (i === 4) ? 'week-5' : '';
                        gastoHTML += `<input type="number" value="${montoValor}" placeholder="0.00" step="0.01" data-name="gasto-pre" readonly class="monto-planeado border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right font-mono text-base ${weekClass}">`;
                    }
                } else {
                    gastoRow.className = `grid grid-cols-[minmax(150px,_2fr)_repeat(5,_minmax(100px,_1fr))] gap-2 items-center bg-white border border-gray-200 rounded-lg`;
                    gastoRow.dataset.rowType = "gasto";
                    gastoRow.dataset.detalles = JSON.stringify(detalles.length ? detalles : ["","","","",""]);
                    gastoHTML = `
                        <div class="sticky left-0 z-5 flex items-center gap-2 bg-white pr-2">
                            <input type="text" value="${concepto}" placeholder="Concepto de gasto..." class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500 text-base">
                            <button class="delete-gasto-btn text-red-400 hover:text-red-600 p-1 rounded-full transition-all">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`;
                    for (let i = 0; i < 5; i++) {
                        const montoValor = montos[i] || ""; 
                        const weekClass = (i === 4) ? 'week-5' : '';
                        gastoHTML += `<input type="number" value="${montoValor}" placeholder="0.00" step="0.01" data-name="gasto-input" readonly class="bg-yellow-100 border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right focus:ring-blue-500 focus:border-blue-500 font-mono text-base cursor-pointer hover:bg-yellow-200 ${weekClass}">`;
                    }
                }
                gastoRow.innerHTML = gastoHTML;
                gridBody.appendChild(gastoRow);
            }

            function calcularTotales() {
                const numSemanas = 5; 
                const sueldoInputs = sueldoRow.querySelectorAll('[data-name="sueldo-input"]');
                const filasGastos = gridBody.querySelectorAll('[data-row-type="gasto"]');
                let totalesSueldo = new Array(numSemanas).fill(0);
                let totalesGasto = new Array(numSemanas).fill(0);
                let totalesRestante = new Array(numSemanas).fill(0);
                sueldoInputs.forEach((input, index) => {
                    totalesSueldo[index] = parseFloat(input.value) || 0;
                });
                filasGastos.forEach(fila => {
                    const gastoInputs = fila.querySelectorAll('[data-name="gasto-input"]');
                    gastoInputs.forEach((input, index) => {
                        totalesGasto[index] += parseFloat(input.value) || 0;
                    });
                });
                for (let i = 0; i < 5; i++) {
                    totalesRestante[i] = totalesSueldo[i] - totalesGasto[i];
                }
                const celdasTotalGasto = totalsGastosRow.querySelectorAll('div:not(:first-child)');
                const celdasTotalRestante = totalsRestanteRow.querySelectorAll('div:not(:first-child)');
                celdasTotalGasto.forEach((celda, index) => { celda.textContent = `$${totalesGasto[index].toFixed(2)}`; });
                celdasTotalRestante.forEach((celda, index) => {
                    celda.textContent = `$${totalesRestante[index].toFixed(2)}`;
                    celda.classList.toggle('text-green-600', totalesRestante[index] >= 0);
                    celda.classList.toggle('text-red-600', totalesRestante[index] < 0);
                });
            }

            function triggerSave() {
                saveStatusEl.textContent = "Sincronizando...";
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(guardarDatos, 1500);
            }

            async function guardarDatos() {
                saveStatusEl.textContent = "Guardando...";
                const mesIndex = monthSelect.value;
                const docId = `${AÑO_ACTUAL}-${String(mesIndex).padStart(2, '0')}`;
                const docRef = doc(registrosColRef, docId);
                const sueldoData = Array.from(sueldoRow.querySelectorAll('[data-name="sueldo-input"]')).map(input => input.value);
                const gastosData = [];
                gridBody.querySelectorAll('[data-row-type="gasto"]').forEach(fila => {
                    const concepto = fila.querySelector('input[type="text"]').value;
                    const montos = Array.from(fila.querySelectorAll('[data-name="gasto-input"]')).map(input => input.value);
                    if (concepto || montos.some(m => m)) {
                        gastosData.push({
                            concepto: concepto, montos: montos,
                            detalles: JSON.parse(fila.dataset.detalles || '["","","","",""]'),
                            esPlaneado: false
                        });
                    }
                });
                gridBody.querySelectorAll('[data-row-type="gasto-planeado"]').forEach(fila => {
                    const concepto = fila.querySelector('input[type="text"]').value;
                    const montos = Array.from(fila.querySelectorAll('[data-name="gasto-pre"]')).map(input => input.value);
                    if (concepto || montos.some(m => m)) {
                        gastosData.push({
                            concepto: concepto, montos: montos,
                            detalles: JSON.parse(fila.dataset.detalles || '["","","","",""]'),
                            esPlaneado: true
                        });
                    }
                });
                const dataPayload = { sueldo: sueldoData, gastos: gastosData };
                try {
                    await setDoc(docRef, dataPayload, { merge: true }); // Usar merge para seguridad
                    saveStatusEl.textContent = "Guardado ✔";
                } catch (e) {
                    console.error("Error guardando datos: ", e);
                    saveStatusEl.textContent = "Error al guardar ❌";
                }
            }

            // --- LÓGICA DEL MODAL (GASTOS) ---
            function parseAndSum(text) {
                let total = 0;
                const lines = text.split('\n');
                for (const line of lines) {
                    const matches = line.match(/([\d\.]+)/g);
                    if (matches) { total += parseFloat(matches[matches.length - 1]) || 0; }
                }
                return total;
            }
            function openItemModal(input) {
                if (input.dataset.name === 'gasto-pre') return; 
                currentModalInput = input;
                const row = input.closest('[data-row-type="gasto"]');
                const concepto = row.querySelector('input[type="text"]').value || "Gasto";
                const inputs = Array.from(row.querySelectorAll('[data-name="gasto-input"]'));
                const weekIndex = inputs.indexOf(input);
                const weekLabel = document.querySelectorAll('#grid-header div')[weekIndex + 1].textContent;
                modalTitle.textContent = `Detalles: ${concepto}`;
                modalSubtitle.textContent = `Semana de ${weekLabel}`;
                const detalles = JSON.parse(row.dataset.detalles || '["","","","",""]');
                modalTextarea.value = detalles[weekIndex] || "";
                itemModal.classList.remove('hidden');
                modalTextarea.focus();
            }

            // --- LÓGICA DE CAJA DE AHORRO (MODIFICADA PARA METAS) ---
            function iniciarListenersCaja() {
                // Listener para el Saldo Total de la Caja
                onSnapshot(cajaDocRef, (doc) => {
                    if (doc.exists()) {
                        saldoCajaGlobal = doc.data().saldoActual || 0;
                    } else {
                        setDoc(cajaDocRef, { saldoActual: 0 }).catch(e => console.error("Error inicializando caja:", e));
                        saldoCajaGlobal = 0;
                    }
                    cajaSaldoEl.textContent = `$${saldoCajaGlobal.toFixed(2)}`;
                    actualizarSaldosDisponibles(); // Actualiza disponible
                });

                // Listener para los Movimientos
                const logQuery = query(cajaLogColRef, orderBy("fecha", "desc"), limit(10));
                onSnapshot(logQuery, (snapshot) => {
                    cajaLogEl.innerHTML = ""; 
                    if (snapshot.empty) {
                        cajaLogEl.innerHTML = '<li class="text-center text-gray-500">No hay movimientos.</li>';
                        return;
                    }
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <p class="log-concepto">${data.concepto || data.tipo}</p>
                                <p class="log-fecha">${data.fecha ? data.fecha.toDate().toLocaleDateString('es-MX', { day: '2-digit', month: 'short' }) : '...'}</p>
                            </div>
                            <span class="log-monto ${data.tipo} font-bold font-mono">
                                ${data.tipo === 'deposito' ? '+' : '-'}$${data.monto.toFixed(2)}
                            </span>`;
                        cajaLogEl.appendChild(li);
                    });
                });
                
                // NUEVO: Listener para las Metas
                onSnapshot(query(metasColRef, orderBy("nombre")), (snapshot) => {
                    metasListaEl.innerHTML = "";
                    let totalAsignado = 0;
                    if (snapshot.empty) {
                        metasListaEl.innerHTML = '<li class="text-center text-gray-500">Aún no tienes metas.</li>';
                    }
                    snapshot.docs.forEach(doc => {
                        const meta = doc.data();
                        const metaId = doc.id;
                        totalAsignado += meta.asignado || 0;
                        const porcentaje = (meta.totalMeta > 0) ? ((meta.asignado / meta.totalMeta) * 100) : 0;
                        
                        const li = document.createElement('li');
                        li.className = "space-y-3";
                        li.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-bold capitalize text-gray-800">${meta.nombre}</span>
                                <div class="flex gap-2">
                                    <button class="abonar-meta-btn bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full hover:bg-green-200" data-id="${metaId}" data-nombre="${meta.nombre}">+ Abonar</button>
                                    <button class="delete-meta-btn text-red-400 hover:text-red-600 p-1" data-id="${metaId}" title="Borrar meta">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-inner" style="width: ${porcentaje.toFixed(2)}%;"></div>
                            </div>
                            <div class="text-sm text-gray-600 font-mono text-right">
                                $${(meta.asignado || 0).toFixed(2)} / $${(meta.totalMeta || 0).toFixed(2)}
                            </div>
                        `;
                        metasListaEl.appendChild(li);
                    });
                    
                    saldoDisponibleGlobal = saldoCajaGlobal - totalAsignado;
                    cajaDisponibleEl.textContent = `$${saldoDisponibleGlobal.toFixed(2)}`;
                });
            }
            
            function actualizarSaldosDisponibles() {
                // Esta función es llamada por los dos listeners (caja y metas)
                getDocs(metasColRef).then(snapshot => {
                    let totalAsignado = 0;
                    snapshot.forEach(doc => {
                        totalAsignado += doc.data().asignado || 0;
                    });
                    saldoDisponibleGlobal = saldoCajaGlobal - totalAsignado;
                    cajaDisponibleEl.textContent = `$${saldoDisponibleGlobal.toFixed(2)}`;
                });
            }

            function openCajaModal(tipo) {
                tipoMovimientoActual = tipo;
                cajaModal.classList.remove('hidden');
                cajaModalMonto.value = "";
                cajaModalConcepto.value = "";
                cajaModalError.classList.add('hidden');
                cajaModalSaveBtn.disabled = false;
                if (tipo === 'deposito') {
                    cajaModalTitle.textContent = "Depositar en Caja";
                    cajaModalSaveBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base";
                } else {
                    cajaModalTitle.textContent = "Retirar de Caja";
                    cajaModalSaveBtn.className = "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-base";
                    cajaModalError.textContent = "Fondos insuficientes (total de caja).";
                }
                cajaModalMonto.focus();
            }
            
            // MODIFICADO: Salva a la caja general
            async function handleCajaSave() {
                const monto = parseFloat(cajaModalMonto.value) || 0;
                let concepto = cajaModalConcepto.value || (tipoMovimientoActual === 'deposito' ? 'Depósito' : 'Retiro');
                if (monto <= 0) {
                    cajaModalError.textContent = "El monto debe ser positivo";
                    cajaModalError.classList.remove('hidden'); return;
                }
                
                if (tipoMovimientoActual === 'retiro' && monto > saldoCajaGlobal) {
                    cajaModalError.textContent = "Fondos insuficientes (total de caja).";
                    cajaModalError.classList.remove('hidden'); return;
                }
                
                cajaModalSaveBtn.disabled = true;
                cajaModalSaveBtn.textContent = "Guardando...";
                try {
                    await runTransaction(db, async (transaction) => {
                        const cajaDoc = await transaction.get(cajaDocRef);
                        const saldoPrevio = cajaDoc.data()?.saldoActual || 0;
                        let nuevoSaldo;
                        if (tipoMovimientoActual === 'deposito') {
                            nuevoSaldo = saldoPrevio + monto;
                        } else {
                            nuevoSaldo = saldoPrevio - monto;
                        }
                        
                        if (cajaDoc.exists()) {
                            transaction.update(cajaDocRef, { saldoActual: nuevoSaldo });
                        } else {
                            transaction.set(cajaDocRef, { saldoActual: nuevoSaldo });
                        }
                        const newLogRef = doc(cajaLogColRef); 
                        transaction.set(newLogRef, {
                            tipo: tipoMovimientoActual, monto: monto, concepto: concepto, fecha: serverTimestamp() 
                        });
                    });
                    cajaModal.classList.add('hidden');
                } catch (e) {
                    console.error("Error en la transacción de ahorro: ", e);
                    cajaModalError.textContent = `Error: ${e.message}`;
                    cajaModalError.classList.remove('hidden');
                }
                cajaModalSaveBtn.disabled = false;
                cajaModalSaveBtn.textContent = "Confirmar";
            }
            
            // --- NUEVO: Listeners Metas ---
            nuevaMetaBtn.addEventListener('click', () => {
                nuevaMetaNombre.value = "";
                nuevaMetaTotal.value = "";
                nuevaMetaModal.classList.remove('hidden');
                nuevaMetaNombre.focus();
            });
            nuevaMetaCloseBtn.addEventListener('click', () => nuevaMetaModal.classList.add('hidden'));
            nuevaMetaSaveBtn.addEventListener('click', async () => {
                const nombre = nuevaMetaNombre.value;
                const totalMeta = parseFloat(nuevaMetaTotal.value) || 0;
                if (!nombre || totalMeta <= 0) {
                    alert("Por favor, pon un nombre y un costo total válido."); return;
                }
                try {
                    const newMetaRef = doc(metasColRef);
                    await setDoc(newMetaRef, {
                        nombre: nombre,
                        totalMeta: totalMeta,
                        asignado: 0
                    });
                    nuevaMetaModal.classList.add('hidden');
                } catch (e) { console.error("Error creando meta:", e); }
            });
            
            // Listener para botones de Abonar/Borrar en la lista
            metasListaEl.addEventListener('click', async (e) => {
                const abonarBtn = e.target.closest('.abonar-meta-btn');
                const deleteBtn = e.target.closest('.delete-meta-btn');
                
                if (abonarBtn) {
                    metaActualId = abonarBtn.dataset.id;
                    abonarMetaTitle.textContent = `Abonar a "${abonarBtn.dataset.nombre}"`;
                    abonarMetaDisponible.textContent = `Saldo Disponible: $${saldoDisponibleGlobal.toFixed(2)}`;
                    abonarMetaMonto.value = "";
                    abonarMetaMonto.max = saldoDisponibleGlobal;
                    abonarMetaError.classList.add('hidden');
                    abonarMetaModal.classList.remove('hidden');
                    abonarMetaMonto.focus();
                }
                
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    const metaDoc = await getDoc(doc(metasColRef, id));
                    const asignado = metaDoc.data().asignado;
                    
                    if (window.confirm(`¿Seguro que quieres borrar esta meta? (Se liberarán $${asignado.toFixed(2)} al Saldo Disponible)`)) {
                        try {
                            await deleteDoc(doc(metasColRef, id));
                            actualizarSaldosDisponibles(); 
                        } catch (e) { console.error("Error borrando meta:", e); }
                    }
                }
            });
            
            abonarMetaCloseBtn.addEventListener('click', () => abonarMetaModal.classList.add('hidden'));
            abonarMetaSaveBtn.addEventListener('click', async () => {
                const montoAbonar = parseFloat(abonarMetaMonto.value) || 0;
                if (montoAbonar <= 0) return;
                if (montoAbonar > saldoDisponibleGlobal) {
                    abonarMetaError.classList.remove('hidden');
                    return;
                }
                
                try {
                    abonarMetaSaveBtn.disabled = true;
                    const metaRef = doc(metasColRef, metaActualId);
                    await runTransaction(db, async (transaction) => {
                        const metaDoc = await transaction.get(metaRef);
                        const asignadoPrevio = metaDoc.data().asignado || 0;
                        const nuevoAsignado = asignadoPrevio + montoAbonar;
                        transaction.update(metaRef, { asignado: nuevoAsignado });
                    });
                    abonarMetaModal.classList.add('hidden');
                } catch (e) { console.error("Error al abonar a meta:", e);
                } finally { abonarMetaSaveBtn.disabled = false; }
            });


            // --- LÓGICA RESUMEN ANUAL (MODIFICADA CON FILTRO) ---
            async function cargarResumen() {
                summaryList.innerHTML = '<li class="text-center text-gray-500 py-8">Calculando resumen...</li>';
                summaryCategoryList.innerHTML = '<li class="text-center text-gray-500 py-4">Calculando...</li>';
                
                const filtroMes = resumenMonthFilter.value; // "annual" o "0"-"11"
                let docs = [];

                try {
                    if (filtroMes === "annual") {
                        summaryTotalTitle.textContent = "Balance Neto (Año)";
                        summaryList.classList.remove('hidden'); // Mostrar lista de meses
                        const q = query(registrosColRef, where(documentId(), '>=', `${AÑO_ACTUAL}-00`), where(documentId(), '<=', `${AÑO_ACTUAL}-11`));
                        const querySnapshot = await getDocs(q);
                        docs = querySnapshot.docs;
                    } else {
                        summaryTotalTitle.textContent = `Balance Neto (${MESES[filtroMes]})`;
                        summaryList.classList.add('hidden'); // Ocultar lista de meses
                        const docId = `${AÑO_ACTUAL}-${String(filtroMes).padStart(2, '0')}`;
                        const docSnap = await getDoc(doc(registrosColRef, docId));
                        if (docSnap.exists()) {
                            docs = [docSnap];
                        }
                    }

                    let granTotalNeto = 0, granTotalSueldo = 0, granTotalGasto = 0;
                    let gastosPorConcepto = {}; 
                    let mesesData = new Array(12).fill(null);
                    
                    docs.forEach(doc => {
                        const mesIndex = parseInt(doc.id.split('-')[1], 10);
                        const data = doc.data();
                        const totalSueldoMes = (data.sueldo || []).reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                        let totalGastoMes = 0;
                        (data.gastos || []).forEach(gasto => {
                            if (!gasto.esPlaneado) {
                                const concepto = gasto.concepto.trim();
                                const totalGastoConcepto = (gasto.montos || []).reduce((a, m) => a + (parseFloat(m) || 0), 0);
                                totalGastoMes += totalGastoConcepto;
                                if (concepto && totalGastoConcepto > 0) {
                                    const conceptoKey = concepto.toLowerCase();
                                    gastosPorConcepto[conceptoKey] = (gastosPorConcepto[conceptoKey] || 0) + totalGastoConcepto;
                                }
                            }
                        });
                        const totalNetoMes = totalSueldoMes - totalGastoMes;
                        granTotalNeto += totalNetoMes;
                        granTotalSueldo += totalSueldoMes;
                        granTotalGasto += totalGastoMes;
                        mesesData[mesIndex] = { totalSueldoMes, totalGastoMes, totalNetoMes };
                    });
                    
                    // Renderizar lista de meses (solo si es anual)
                    if (filtroMes === "annual") {
                        summaryList.innerHTML = ""; 
                        MESES.forEach((mesNombre, index) => {
                            const data = mesesData[index];
                            const li = document.createElement('li');
                            li.className = "summary-item";
                            if (data) {
                                const netoColor = data.totalNetoMes >= 0 ? 'text-green-600' : 'text-red-600';
                                const netoSigno = data.totalNetoMes >= 0 ? '+' : '';
                                li.innerHTML = `
                                    <div class="flex-1">
                                        <p class="text-lg font-bold text-gray-900">${mesNombre}</p>
                                        <div class="flex flex-col sm:flex-row sm:gap-4 text-sm">
                                           <span class="text-green-600">Sueldo: $${data.totalSueldoMes.toFixed(2)}</span>
                                           <span class="text-red-600">Gasto: $${data.totalGastoMes.toFixed(2)}</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">Balance</p>
                                        <p class="text-lg font-bold font-mono ${netoColor}">${netoSigno}$${data.totalNetoMes.toFixed(2)}</p>
                                    </div>`;
                            } else {
                                li.innerHTML = `
                                    <div><p class="text-lg font-bold text-gray-400">${mesNombre}</p></div>
                                    <div class="text-right"><p class="text-lg font-mono text-gray-400">Sin datos</p></div>`;
                            }
                            summaryList.appendChild(li);
                        });
                    }

                    // Renderizar Totales
                    summaryTotalNeto.textContent = `${granTotalNeto >= 0 ? '+' : ''}$${granTotalNeto.toFixed(2)}`;
                    summaryTotalNeto.classList.toggle('text-green-400', granTotalNeto >= 0);
                    summaryTotalNeto.classList.toggle('text-red-400', granTotalNeto < 0);
                    summaryTotalGanado.textContent = `$${granTotalSueldo.toFixed(2)}`;
                    summaryTotalGastado.textContent = `-$${granTotalGasto.toFixed(2)}`;
                    
                    // Renderizar Gastos por Concepto
                    summaryCategoryList.innerHTML = "";
                    const sortedGastos = Object.entries(gastosPorConcepto).sort((a, b) => b[1] - a[1]);
                    if (sortedGastos.length === 0) {
                        summaryCategoryList.innerHTML = '<li class="text-center text-gray-500">No hay gastos con concepto.</li>';
                    } else {
                        sortedGastos.forEach(([concepto, total]) => {
                            const li = document.createElement('li');
                            li.className = "flex justify-between items-center py-2 border-b border-gray-100";
                            li.dataset.concepto = concepto; // Data para el click
                            li.innerHTML = `
                                <span class="text-base text-gray-800 capitalize">${concepto}</span>
                                <span class="text-base font-mono font-bold text-red-600">-$${total.toFixed(2)}</span>`;
                            summaryCategoryList.appendChild(li);
                        });
                    }
                    
                    // Renderizar Gráfica (Dona)
                    const chartLabels = sortedGastos.map(item => item[0]);
                    const chartData = sortedGastos.map(item => item[1]);
                    dibujarGraficaDona(chartLabels, chartData);

                } catch (e) {
                    console.error("Error cargando resumen: ", e);
                    summaryList.innerHTML = `<li class="text-center text-red-500 py-8">Error al cargar resumen: ${e.message}</li>`;
                    summaryCategoryList.innerHTML = `<li class="text-center text-red-500 py-4">Error</li>`;
                }
            }
            
            function dibujarGraficaDona(labels, data) {
                const ctx = chartCanvas.getContext('2d');
                if (gastosChartInstance) { gastosChartInstance.destroy(); }
                const bgColors = ['#EF4444', '#F97316', '#F59E0B', '#EAB308', '#84CC16', '#22C55E', '#10B981', '#14B8A6', '#06B6D4', '#0EA5E9', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#D946EF', '#EC4899', '#F43F5E'];
                gastosChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                        datasets: [{ label: 'Gastos por Concepto', data: data, backgroundColor: bgColors.slice(0, data.length), hoverOffset: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12, font: { size: 14 } } } }
                    }
                });
            }
            
            // --- NUEVO: Lógica de Gráfica de Tendencia ---
            async function mostrarTendenciaDeGasto(concepto) {
                tendenciaModalTitle.textContent = `Tendencia de: ${concepto.charAt(0).toUpperCase() + concepto.slice(1)}`;
                tendenciaModal.classList.remove('hidden');
                
                let tendenciaData = new Array(12).fill(0);
                try {
                    const q = query(registrosColRef, where(documentId(), '>=', `${AÑO_ACTUAL}-00`), where(documentId(), '<=', `${AÑO_ACTUAL}-11`));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach(doc => {
                        const mesIndex = parseInt(doc.id.split('-')[1], 10);
                        const data = doc.data();
                        let gastoMes = 0;
                        (data.gastos || []).forEach(gasto => {
                            if (!gasto.esPlaneado && gasto.concepto.toLowerCase() === concepto.toLowerCase()) {
                                gastoMes += (gasto.montos || []).reduce((a, m) => a + (parseFloat(m) || 0), 0);
                            }
                        });
                        tendenciaData[mesIndex] = gastoMes;
                    });
                    
                    dibujarGraficaTendencia(tendenciaData);
                    
                } catch(e) {
                    console.error("Error cargando tendencia:", e);
                }
            }
            
            function dibujarGraficaTendencia(data) {
                const ctx = tendenciaChartCanvas.getContext('2d');
                if (tendenciaChartInstance) { tendenciaChartInstance.destroy(); }
                
                tendenciaChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: MESES.map(m => m.substring(0,3)), // "Ene", "Feb", etc.
                        datasets: [{
                            label: 'Gasto Mensual',
                            data: data,
                            fill: false,
                            borderColor: '#3B82F6', // blue-500
                            backgroundColor: '#3B82F6',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            
            // --- LÓGICA DE AJUSTES (GASTOS FIJOS) ---
            function iniciarListenersAjustes() {
                gastoFijoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const concepto = document.getElementById('gasto-fijo-concepto').value;
                    const monto = parseFloat(document.getElementById('gasto-fijo-monto').value);
                    const dia = parseInt(document.getElementById('gasto-fijo-dia').value);
                    if (!concepto || !monto || !dia) { alert("Por favor completa todos los campos."); return; }
                    try {
                        const newDocRef = doc(gastosFijosColRef);
                        await setDoc(newDocRef, { concepto: concepto, monto: monto, dia: dia });
                        gastoFijoForm.reset();
                    } catch (e) { console.error("Error agregando gasto fijo:", e); alert("Error al guardar el gasto."); }
                });
                onSnapshot(query(gastosFijosColRef, orderBy("dia")), (snapshot) => {
                    gastosFijosLista.innerHTML = "";
                    if (snapshot.empty) {
                        gastosFijosLista.innerHTML = '<li class="text-center text-gray-500">No hay gastos fijos.</li>';
                        return;
                    }
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <p class="log-concepto capitalize">${data.concepto}</p>
                                <p class="log-fecha">Día ${data.dia} de cada mes</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="log-monto font-bold font-mono">-$${data.monto.toFixed(2)}</span>
                                <button class="delete-gasto-fijo-btn text-red-400 hover:text-red-600" data-id="${doc.id}" data-concepto="${data.concepto}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>`;
                        gastosFijosLista.appendChild(li);
                    });
                });
            }

            // --- INICIALIZACIÓN DE LA APP ---
            popularMeses();
            dibujarGrid(monthSelect.value); // Llama inicial
            iniciarListenersCaja(); 
            iniciarListenersAjustes();

            // --- EVENT LISTENERS (GRID) ---
            monthSelect.addEventListener('change', (e) => dibujarGrid(e.target.value));
            addRowBtn.addEventListener('click', () => {
                agregarFilaDeGasto();
                triggerSave(); 
            });
            gridBody.addEventListener('input', (e) => {
                if(e.target.tagName === 'INPUT' && (e.target.dataset.name === 'sueldo-input' || e.target.type === 'text')) {
                    calcularTotales(); 
                    triggerSave();    
                }
            });
            gridBody.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-gasto-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('[data-row-type]'); 
                    if (row) {
                        row.remove();
                        calcularTotales();
                        triggerSave();
                    }
                    return; 
                }
                const confirmBtn = e.target.closest('.confirm-gasto-btn');
                if (confirmBtn) {
                    const row = confirmBtn.closest('[data-row-type="gasto-planeado"]');
                    row.dataset.rowType = "gasto";
                    row.classList.remove('gasto-planeado');
                    const conceptoInput = row.querySelector('input[type="text"]');
                    const btnContainer = confirmBtn.parentElement;
                    btnContainer.innerHTML = `
                        <input type="text" value="${conceptoInput.value}" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500 text-base">
                        <button class="delete-gasto-btn text-red-400 hover:text-red-600 p-1 rounded-full transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>`;
                    row.querySelectorAll('[data-name="gasto-pre"]').forEach(input => {
                        input.dataset.name = "gasto-input";
                        input.readOnly = true;
                        input.className = "bg-yellow-100 border border-gray-300 text-gray-900 rounded-lg p-2 w-full text-right focus:ring-blue-500 focus:border-blue-500 font-mono text-base cursor-pointer hover:bg-yellow-200";
                    });
                    calcularTotales();
                    triggerSave();
                    return;
                }
                const gastoInput = e.target.closest('[data-name="gasto-input"]');
                if (gastoInput) { openItemModal(gastoInput); }
            });

            // --- Listeners Modal Gasto ---
            modalCloseBtn.addEventListener('click', () => {
                itemModal.classList.add('hidden');
                currentModalInput = null;
            });
            modalSaveBtn.addEventListener('click', () => {
                if (!currentModalInput) return;
                const text = modalTextarea.value;
                const sum = parseAndSum(text);
                currentModalInput.value = sum.toFixed(2);
                const row = currentModalInput.closest('[data-row-type="gasto"]');
                const inputs = Array.from(row.querySelectorAll('[data-name="gasto-input"]'));
                const weekIndex = inputs.indexOf(currentModalInput);
                let detalles = JSON.parse(row.dataset.detalles || '["","","","",""]');
                detalles[weekIndex] = text;
                row.dataset.detalles = JSON.stringify(detalles);
                itemModal.classList.add('hidden');
                currentModalInput = null;
                calcularTotales();
                triggerSave();
            });

            // --- Listeners Modal Caja ---
            cajaDepositoBtn.addEventListener('click', () => openCajaModal('deposito'));
            cajaRetiroBtn.addEventListener('click', () => openCajaModal('retiro'));
            cajaModalCloseBtn.addEventListener('click', () => cajaModal.classList.add('hidden'));
            cajaModalSaveBtn.addEventListener('click', handleCajaSave);
            cajaModalMonto.addEventListener('input', () => {
                const monto = parseFloat(cajaModalMonto.value) || 0;
                if (tipoMovimientoActual === 'retiro') {
                    cajaModalError.classList.toggle('hidden', monto <= saldoCajaGlobal);
                }
            });

            // --- Listeners Resumen (NUEVOS) ---
            resumenMonthFilter.addEventListener('change', cargarResumen);
            
            toggleLista.addEventListener('click', () => {
                summaryListaView.classList.remove('hidden');
                summaryGraficaView.classList.add('hidden');
                toggleLista.classList.add('active');
                toggleGrafica.classList.remove('active');
            });
            toggleGrafica.addEventListener('click', () => {
                summaryListaView.classList.add('hidden');
                summaryGraficaView.classList.remove('hidden');
                toggleLista.classList.remove('active');
                toggleGrafica.classList.add('active');
            });
            
            // Listener para Gráfica de Tendencia
            summaryCategoryList.addEventListener('click', (e) => {
                const li = e.target.closest('li[data-concepto]');
                if (li) {
                    mostrarTendenciaDeGasto(li.dataset.concepto);
                }
            });
            tendenciaModalCloseBtn.addEventListener('click', () => tendenciaModal.classList.add('hidden'));
            
            // --- Listeners Ajustes (Delete) ---
            gastosFijosLista.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-gasto-fijo-btn');
                if (deleteBtn) {
                    const docId = deleteBtn.dataset.id;
                    const concepto = deleteBtn.dataset.concepto;
                    if (window.confirm(`¿Seguro que quieres borrar "${concepto}"? Esto lo quitará de tus recordatorios futuros.`)) {
                        try {
                            await deleteDoc(doc(gastosFijosColRef, docId));
                            await actualizarMesesAbiertos(concepto);
                        } catch (e) { console.error("Error borrando gasto fijo:", e); }
                    }
                }
            });

            async function actualizarMesesAbiertos(concepto) {
                if (!concepto) return;
                const conceptoLower = concepto.toLowerCase();
                try {
                    const q = query(registrosColRef, where(documentId(), '>=', `${AÑO_ACTUAL}-00`), where(documentId(), '<=', `${AÑO_ACTUAL}-11`));
                    const querySnapshot = await getDocs(q);
                    const batch = runTransaction(db, async (transaction) => {
                        for (const docSnap of querySnapshot.docs) {
                            const docData = docSnap.data();
                            if (docData.gastos && docData.gastos.length > 0) {
                                const gastosNuevos = docData.gastos.filter(g => {
                                    return !(g.esPlaneado && g.concepto.toLowerCase() === conceptoLower);
                                });
                                if (gastosNuevos.length < docData.gastos.length) {
                                    transaction.update(docSnap.ref, { gastos: gastosNuevos });
                                }
                            }
                        }
                    });
                    if (document.getElementById('register-view').classList.contains('hidden') === false) {
                        dibujarGrid(monthSelect.value);
                    }
                } catch (e) { console.error("Error actualizando meses abiertos:", e); }
            }
        }
if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker
                .register("/sw.js")
                .then(() => console.log("Service Worker registrado"))
                .catch(err => console.log("Error SW:", err));
        });
    }
</script>
</body>
</html>